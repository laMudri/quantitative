\documentclass[submission,copyright,creativecommons]{eptcs}
\providecommand{\event}{SOS 2007} % Name of the event you are submitting to
\usepackage{breakurl}             % Not needed if you use pdflatex only.
\usepackage{underscore}           % Only needed if you use pdflatex.

\usepackage{stmaryrd}
\usepackage{mathpartir}
\usepackage{amssymb}
\usepackage{cmll}
\usepackage{xcolor}
\usepackage{paralist}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{mathrsfs}
\usepackage{mathtools}
\usepackage{tabularx}
\usepackage{tikz-cd}

\newtheorem{theorem}{Theorem}[section]
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{example}[theorem]{Example}
\newtheorem{definition}[theorem]{Definition}

\def\newelims{1}
\def\multnotation{1}
\input{../macros.tex}

\newcommand{\kitrel}{\mathbin{\blacklozenge}}

\title{An Algebraically Structured Approach to Substructural Substitution}
\author{Robert Atkey
\institute{University of Strathclyde\\ Glasgow, United Kingdom}
\email{robert.atkey@strath.ac.uk}
\and
James Wood
\institute{University of Strathclyde\\ Glasgow, United Kingdom}
\email{james.wood.100@strath.ac.uk}
}
\def\titlerunning{An Algebraically Structured Approach to Substructural
  Substitution}
\def\authorrunning{R. Atkey \& J. Wood}
\begin{document}
\maketitle

\begin{abstract}
  We present a nice way to prove syntactic lemmas for linear type theory.
\end{abstract}

\section{Introduction}

\section{Usage algebra}

A \emph{usage algebra} can be summarised as a partially ordered semiring.
A usage algebra $(\mathscr R, \subres, 0, +, 1, *)$ is a structure in which
$(\mathscr R, \subres)$ forms a partial order, $(\mathscr R, 0, +, 1, *)$ forms
a semiring, and $+$ and $*$ are monotonic with respect to $\subres$.
Unpacking slightly more, we take a semiring to be a structure
$(\mathscr R, 0, +, 1, *)$ such that $(\mathscr R, 0, +)$ is a commutative
monoid, $(\mathscr R, 1, *)$ is a monoid, $*$ is annihilated by $0$, and $*$
distributes over $+$.

Elements of a usage algebra are called \emph{usage annotations}, and describe
\emph{how} resources are used in a program.
In the syntax for \name, each assumption will have a usage annotation,
describing how that assumption can be used in the derivation.
The additive structure describes how to combine multiple usages of an
assumption, and the multiplicative structure describes what happens when usage
requirements are composed.
In standard proof tree notation, addition can be seen as acting horizontally,
whereas multiplication acts vertically.
The ordering describes the specificness of annotations.
If $\pi \subres \rho$, $\pi$ can be the annotation for a variable wherever
$\rho$ can be.
We can read this relation as ``$\textrm{supply} \subres \textrm{demand}$'' ---
where we demand that a variable be used according to $\rho$, it is also fine to
use it as $\pi$.

\subsection{Vectors and matrices}

\begin{definition}
  A \emph{left semimodule} over a semiring $\mathscr R$ is a structure
  $(\mathscr M, 0 : \mathscr M, + : \mathscr M \times \mathscr M \to \mathscr M,
  * : \mathscr R \times \mathscr M \to \mathscr M)$ such that
  \begin{itemize}
  \item $(\mathscr M, 0, +)$ is a commutative monoid
  \item Scaling of a fixed element $m$ respects all of the semiring structure
    particularly:
    \begin{itemize}
    \item $0_\mathscr R * m = 0_\mathscr M$
    \item $(\pi +_\mathscr R \rho) * m = \pi * m +_\mathscr M \rho * m$
    \item $1_\mathscr R * m = m$
    \item $(\pi *_\mathscr R \rho) * m = \pi * (\rho * m)$
    \end{itemize}
  \item Scaling by a fixed element $\pi$ respects the additive structure;
    particularly:
    \begin{itemize}
    \item $\pi * 0_\mathscr M = 0_\mathscr M$
    \item $\pi * (m +_\mathscr M n) = \pi * m +_\mathscr M \pi * n$
    \end{itemize}
  \end{itemize}
\end{definition}

\begin{definition}
  A \emph{(left) semimodule homomorphism} or \emph{linear map} between
  $\mathscr R$-left semimodules $\mathscr M$ and $\mathscr N$ is a function $T$
  on the underlying sets such that all of the semimodule structure is preserved.
  Particularly,
  \begin{itemize}
  \item $T(0_\mathscr M) = 0_\mathscr N$
  \item $T(m +_\mathscr M n) = T(m) +_\mathscr N T(n)$
  \item $T(\pi *_\mathscr M m) = \pi *_\mathscr N T(m)$
  \end{itemize}
\end{definition}

A semiring is just about enough structure to let us talk about finite vectors,
and let us represent linear maps as matrices.
To the standard operations of addition, scaling, and multiplication of vectors
and matrices, we also say that the order lifts pointwise.

Conversely to standard practice, matrices will typically right-multiply vectors,
rather than left-multiply.
Following this practice, a linear transformation
$T : \mathscr R^m \to \mathscr R^n$ is represented by an $m \times n$ matrix
$M_T$, and the application of a linear map $T(v)$ is represented by $vM_T$.

\begin{definition}[Standard basis]
  \begin{align*}
    \langle i \rvert_j =
    \begin{cases}
      1, & \textrm{if }i = j \\
      0, & \textrm{otherwise} \\
    \end{cases}
  \end{align*}
\end{definition}

\begin{definition}[Matrix operations]
    \begin{align*}
      0 &: \mathrm{Mat}~m~n \\
      0_{ij} &= 0 \\
      + &: \mathrm{Mat}~m~n \times \mathrm{Mat}~m~n \to \mathrm{Mat}~m~n \\
      (M + N)_{ij} &= M_{ij} + N_{ij} \\
      1 &: \mathrm{Mat}~m~m \\
      1_{ij} &= \langle i \rvert_j \\
      * &: \mathrm{Mat}~m~n \times \mathrm{Mat}~n~o \to \mathrm{Mat}~m~o \\
      (MN)_{ik} &= \sum_j M_{ij}N_{jk}
    \end{align*}
\end{definition}

\begin{lemma}
  Natural numbers and matrices between them form a symmetric monoidal category.
\end{lemma}

\begin{lemma}
  Each matrix $M : \mathrm{Mat}~m~n$ gives rise to a linear map
  $T_M : \mathscr R^m \to \mathscr R^n$ by right-multiplication.
\end{lemma}
\begin{proof}
  We observe the following equations:
  \begin{itemize}
  \item $\left(\vec 0M\right)_{k} = \sum_j 0M_{jk} = 0 = \vec 0_{k}$
  \item $\left((u + v)M\right)_{k} = \sum_j \left(u_j + v_j\right)M_{jk} =
    \sum_j u_jM_{jk} + \sum_j v_jM_{jk} = (uM + vM)_{k}$
  \item $\left((\pi u)M\right)_{k} = \sum_j \pi u_jM_{jk} =
    \pi\sum_j u_jM_{jk} = \left(\pi(uM)\right)_{k}$
  \end{itemize}
\end{proof}

\begin{lemma}
  Each linear map $T : \mathscr R^m \to \mathscr R^n$ gives rise to a matrix
  $M : \mathrm{Mat}~m~n$ with the same action.
\end{lemma}
\begin{proof}
  We construct $M$ as follows.
  \[
    M_{jk} = T(\langle j \rvert)_k
  \]
  Then, consider $uM$.
  \[
    (uM)_k = \sum_j u_jM_{jk} = \sum_j u_jT\left(\langle j \rvert\right)_k
    = T\left(\sum_j u_j\langle j \rvert\right)_k
  \]
  Note that $\sum_j u_j\langle j \rvert$ is exactly $u$, so we are done.
\end{proof}

\section{Syntax}

\section{Metatheory}

We prove all of our main syntactic lemmas via McBride's kits and traversals
method \cite{rensub05}.
Our main modifications are the following.
\begin{itemize}
  \item Kits need not support arbitrary weakening, but rather weakening by the
    introduction of $0$-use variables.
  \item The environment is made linear by equipping it with a matrix (linear map)
    mediating between the input and output usage annotations.
\end{itemize}

\subsection{Kit}

A kit is a structure on relations
$\kitrel : \mathrm{Ctx} \times \mathrm{Ty} \to \mathrm{Set}$, intuitively
giving a way in which $\kitrel$ lives between the usage-checked variable
judgement $\lvar$ and the typing judgement $\vdash$.
We require the following functions, where all undefined variables are
universally quantified.

\begin{itemize}
  \item
    $\mathit{psh} : \resctx P \subres \resctx Q \to
    \ctx{\Gamma}{Q} \kitrel A \to \ctx{\Gamma}{P} \kitrel A$
  \item $\mathit{vr} : \ctx{\Gamma}{P} \lvar A \to
    \ctx{\Gamma}{P} \kitrel A$
  \item $\mathit{tm} : \ctx{\Gamma}{P} \kitrel A \to
    \ctx{\Gamma}{P} \vdash A$
  \item $\mathit{wk} : \ctx{\Gamma}{P} \kitrel A \to
    \ctx{\Gamma}{P}, \ctx{\Delta}{\vct 0} \kitrel A$
\end{itemize}

An inhabitant of $\ctx{\Gamma}{P} \kitrel A$ is described as
\emph{stuff in $\ctx{\Gamma}{P}$ of type $A$}.

\subsection{Environment}

In simple intuitionistic type theory, an environment is just a type-preserving
function from variables in the old context $\Delta$ to stuff in the new context
$\Gamma$.
That is, the environment is an inhabitant of
$\Delta \ni A \to \Gamma \kitrel A$.
The traversal function $\mathit{trav}$ turns such an environment into a map
between terms, $\Delta \vdash A \to \Gamma \vdash A$.

In \name, we want inhabitants of
$\ctx{\Delta}{Q} \vdash A \to \ctx{\Gamma}{P} \vdash A$.
We can see that an environment of type
$\ctx{\Delta}{Q} \lvar A \to \ctx{\Gamma}{P} \kitrel A$ would
be insufficient --- $\ctx{\Delta}{Q} \lvar A$ can only be inhabited when
$\resctx Q$ is compatible with a basis vector, so our environment would be
trivial in more general cases.
Instead, we care about non-usage-checked variables $\Delta \ni A$.

Our understanding of an environment is that it should simultaneously map all of
the usage-checked variables in $\ctx{\Delta}{Q}$ to stuff in $\ctx{\Gamma}{P}$
in a way that preserves usage.
As such, we want to map each variable $j : \Delta \ni A$ not to $A$-stuff in
$\ctx{\Gamma}{P}$, but rather $A$-stuff in $\ctx{\Gamma}{P_j}$, where $P_j$ is
some fragment of $\resctx P$.
Precisely, when weighted by $\resctx Q\lvert j \rangle$, we want these
$\resctx P_j$ to sum to $\resctx P$, so as to provide ``enough'' usage to cover
all of the variables $j$.
When we collect all of the $\resctx P_j$ into a matrix $\rescomment\Psi$, we
notice that the condition just described is stated succinctly via a
vector-matrix multiplication $\resctx Q\rescomment\Psi$.

% On the other hand, the purpose of the environment is that we will eventually
% apply it to variables from the term language, which are usage-checked variables.
% In other words, the usage context $\resctx Q$ of the entire term we're
% traversing over will be whittled away until we get a $\resctx{Q'}$
% such that $\ctx{\Delta}{Q'} \lvar A$.
% Correspondingly,

This culminates to give us the following requirements.

\begin{itemize}
  \item $\rescomment\Psi : \mathscr R^{n \times m}$
  \item $\mathit{act} :
    (j : (\Delta \ni A)) \to (\langle j \rvert\rescomment\Psi)\Gamma \kitrel A$
  \item such that $\resctx P \subres \resctx Q \rescomment\Psi$.
\end{itemize}

We shall write the type of such bundles as
$\ctx{\Gamma}{P} \subst{\kitrel} \ctx{\Delta}{Q}$.
%$\env{\ctx{\Gamma}{P}}{\kitrel}{\ctx{\Delta}{Q}}$.

\subsection{Traversal}

\begin{lemma}[bind]\label{lem:bind}
  Given a kit on $\kitrel$, we can extend an environment of type
  $\ctx{\Gamma}{P} \subst{\kitrel} \ctx{\Delta}{Q}$, to an environment of type
  $\ctx{\Gamma}{P}, \ctx{\Theta}{R} \subst{\kitrel}
  \ctx{\Delta}{Q}, \ctx{\Theta}{R}$.
\end{lemma}
\begin{proof}
  Let the environment we are given be
  $(\rescomment\Psi : \mathscr R^{n \times m},
  \mathit{act} : (j : \Delta \ni A) \to (\langle j \rvert\rescomment\Psi)\Gamma \kitrel A)$,
  with $\resctx P \subres \resctx Q \rescomment\Psi$.
  We are trying to construct
  $(\rescomment{\Psi'} : \mathscr R^{(n + o) \times (m + o)},
  \mathit{act'} : (j : \Delta, \Theta \ni A) \to
  (\langle j \rvert\rescomment\Psi')(\Gamma, \Theta) \kitrel A)$,
  with $\resctx P, \resctx R \subres (\resctx Q, \resctx R) \rescomment\Psi'$.

  Let \(
    \rescomment\Psi' := \left(\begin{array}{c|c}
                                \rescomment\Psi & \rescomment{\mat 0}
                                \\ \hline
                                \rescomment{\mat 0} & \rescomment{\mat I}
                              \end{array}\right).
  \)
  With this definition, our required condition splits into the following easily
  checked conditions.
  \begin{itemize}
    \item
      $\resctx P \subres
      \resctx Q\rescomment\Psi + \resctx R\rescomment{\mat 0}$
    \item
      $\resctx R \subres
      \resctx Q\rescomment{\mat 0} + \resctx R\rescomment{\mat I}$
  \end{itemize}

  For $\mathit{act'}$, we take cases on whether $j$ is from $\Delta$ or from
  $\Theta$.

  In the $\Delta$ case, $\mathit{act}$ gets us an inhabitant of
  $(\langle j \rvert\rescomment\Psi)\Gamma \kitrel A$.
  Notice that
  $\langle j \rvert\rescomment\Psi' =
  \langle j \rvert\rescomment\Psi, \rescomment{\vct 0}$,
  so we want to get from $(\langle j \rvert\rescomment\Psi)\Gamma \kitrel A$ to
  $(\langle j \rvert\rescomment\Psi)\Gamma, \rescomment{\vct 0}\Theta
  \kitrel A$.
  We can get this using $\mathit{wk}$ from our kit.

  In the $\Theta$ case, notice that
  $\langle j \rvert\rescomment\Psi' = \rescomment{\vct 0}, \langle j \rvert$.
  In other words, $\langle j \rvert\rescomment\Psi'$ is a basis vector, so we
  actually have usage-checked
  $(\langle j \rvert\rescomment\Psi')(\Gamma, \Theta) \lvar A$.
  Thus, we can use $\mathit{vr}$ from our kit to get
  $(\langle j \rvert\rescomment\Psi')(\Gamma, \Theta) \kitrel A$, as required.
\end{proof}

\begin{lemma}[traversal]\label{lem:trav}
  Given a kit on $\kitrel$ and an environment
  $\ctx{\Gamma}{P} \subst{\kitrel} \ctx{\Delta}{Q}$, we can transform a term
  $\ctx{\Delta}{Q} \vdash A$ into a term $\ctx{\Gamma}{P} \vdash A$.
  %There exists an $M'$ calculated from the surrounding data such that the
  %following rule is admissible.
  %\[
  %  \inferrule*[right=trav]{
  %    \mathrm{Kit}~{\kitrel}
  %    \\ \ctx{\Gamma}{P} \subst{\kitrel} \ctx{\Delta}{Q}
  %    \\ \ctx{\Delta}{Q} \vdash M : A
  %  }
  %  {
  %    \ctx{\Gamma}{P} \vdash M' : A
  %  }
  %\]
\end{lemma}
\begin{proof}
  By induction on the syntax of $M$. (This is really important!)
  \begin{description}
    \item[variable $x : \ctx{\Delta}{Q} \lvar A$:]
      By definition of $\lvar$, we have that
      $\resctx Q \subres \langle j \rvert$ for some $j$.
      Applying the action of the environment, we have
      $(\langle j \rvert\rescomment\Psi)\Gamma \kitrel A$.
      We then have
      $\resctx P \subres \resctx Q\rescomment\Psi \subres \langle j \rvert\rescomment\Psi$,
      so using the fact that stuff appropriately respects subusaging
      ($\mathit{psh}$), we have $\ctx{\Gamma}{P} \kitrel A$.
      Finally, using $\mathit{tm}$, we get a term $\ctx{\Gamma}{P} \vdash A$, as
      required.
  \end{description}
\end{proof}

\subsection{Subusaging}

Similar to subtyping, we have as an admissible rule that if subusaging holds
pointwise between two annotation contexts, we can coerce any typing derivation.

\begin{lemma}[sub-usaging]\label{lem:subuse}
  The following rule is admissible.
  \[
    \inferrule*[right=subuse]{
      \ctx{\Gamma}{Q} \vdash M : A
      \\ \resctx P \subres \resctx Q
    }
    {
      \ctx{\Gamma}{P} \vdash M : A
    }
  \]
\end{lemma}
\begin{proof}
  By induction on the usage derivation until a rule with splitting is
  encountered.
  Here, we will just consider splitting by addition, but the other cases are
  similar.
  Suppose we are given a derivation of $\ctx{\Gamma}{P} \vdash M : A$,
  from which one of the premises is
  $\resctx Q \subres \resctx Q_0 + \resctx Q_1$.
  Then, because $\resctx P \subres \resctx Q$, we also have
  $\resctx P \subres \resctx Q_0 + \resctx Q_1$.
  Therefore, we can give a derivation for
  $\ctx{\Gamma}{Q} \vdash M : A$ which is the same as the derivation we
  were given, except with the updated splitting premise.
\end{proof}

\subsection{Weakening}

The content of a weakening is an order-preserving embedding (OPE).
An OPE $\theta$ from $m$ to $n$ yields an $m \times n$ matrix $\resmat S_\theta$
mapping (via right-multiplication) the everywhere-$1$ row vector of length $m$
to the bit vector describing the OPE (of length $n$).
In this matrix, each row is either a basis vector or the $\vec 0$ vector, with
basis vectors used in order.
In the same way that weakening is a special case of substitution, we will see
that where $\resmat S_\theta$ justifies a weakening, a matrix of arbitrary form
may justify a substitution.

\begin{lemma}[weakening]\label{lem:weak}
  The following rule is admissible.
  \[
    \inferrule*[right=weak]{
      \ctx{(\theta\Gamma)}{Q} \vdash M : A
      \\ \resctx P \subres \resctx Q \resmat S_\theta
    }
    {
      \ctx{\Gamma}{P} \vdash M[\theta] : A
    }
  \]
\end{lemma}
\begin{proof}
  By structural induction\ldots
\end{proof}

\subsection{Definition of a substitution}

Simultaneous substitution (henceforth just ``substitution'') is a generalisation
of weakening.
Where in weakening, variables are substituted by new variables, in substitution,
variables are substituted by terms in a new context.
Without the OPE $\theta$, we must decide what matrix specifies the relationship
between the premises and the conclusion.

Substitution is the most liberal notion of morphism between contexts one would
typically consider.
It allows arbitrary use of the type theory in order to state that one context
can be derived from another.
We take this as the motivation for allowing a linear transformation of arbitrary
form to justify a substitution.

In the abstract, our admissible rule for substitution is going to look like the
following.

\[
  \inferrule*[right=subst]{
    \ctx{\Delta}{Q} \vdash M : A
    \\ \ctx{\Gamma}{P} \subst{\sigma} \ctx{\Delta}{Q}
  }
  {
    \ctx{\Gamma}{P} \vdash M[\sigma] : A
  }
\]

Our task is to define $\ctx{\Gamma}{P} \subst{\sigma} \ctx{\Delta}{Q}$.
Intuitively, we can consider separately the production of typed terms required
and usage constraints.
Doing this, the first part is standard --- we require a term in $\Gamma$ for
each variable in $\Delta$.
We then need to consider the usage constraints on these terms, and the
relationship between $\resctx P$ and $\resctx Q$.

We will start by looking at the variables in the substituting terms (the terms
in $\Gamma$ that are substituted in for variables in $\Delta$).
Suppose that $\Gamma$ has variables $x_1, \ldots, x_m$ and $\Delta$ has
variables $y_1, \ldots, y_n$, with terms $N_1, \ldots, N_n$ being substituted in
for these variables.
Then, how $x_i$ is used in $M[\sigma]$ depends on two things:

\begin{enumerate}
\item How $x_i$ is used in each $N_j$
\item How each $y_j$ being substituted is used in $M$
\end{enumerate}

More precisely, how $x_i$ is used is a sum of how it is used in each $N_j$,
weighted by how $y_j$ is used in $M$.
If we let $x_i$ be used in $N_j$ according to annotation $\resmat S_{ji}$ and
allow for subusaging, this is captured by the constraint
$\resctx P \subres \resctx Q \resmat S$.

%

\subsection{Linear combinations of usage contexts}

%

\subsection{Binding}

\subsection{Substitution}

\subsection{Single substitution}

\section{Conclusion}

\section{Bibliography}

\bibliographystyle{eptcsalpha}
\bibliography{../quantitative}
\end{document}
